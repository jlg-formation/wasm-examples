<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AssemblyScript - @external Imports</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 p-8">
    <div class="max-w-2xl mx-auto">
      <h1 class="text-3xl font-bold text-gray-800 mb-6">
        AssemblyScript - @external Imports
      </h1>

      <div class="space-y-4">
        <div class="bg-white rounded-lg shadow p-4">
          <h2 class="text-xl font-semibold text-blue-600 mb-2">logNumber()</h2>
          <p class="text-gray-600 mb-2">
            Appelle une fonction JS pour logger des nombres
          </p>
          <button
            id="btn-log"
            class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
          >
            Compter jusqu'√† 5
          </button>
          <div
            id="log-result"
            class="mt-2 font-mono bg-gray-100 p-2 rounded h-24 overflow-auto"
          ></div>
        </div>

        <div class="bg-white rounded-lg shadow p-4">
          <h2 class="text-xl font-semibold text-green-600 mb-2">
            getTimestamp()
          </h2>
          <p class="text-gray-600 mb-2">
            Utilise performance.now() depuis WASM
          </p>
          <button
            id="btn-time"
            class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600"
          >
            Mesurer le temps
          </button>
          <div
            id="time-result"
            class="mt-2 font-mono bg-gray-100 p-2 rounded"
          ></div>
        </div>

        <div class="bg-white rounded-lg shadow p-4">
          <h2 class="text-xl font-semibold text-purple-600 mb-2">notify()</h2>
          <p class="text-gray-600 mb-2">WASM notifie JS du r√©sultat</p>
          <button
            id="btn-calc"
            class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600"
          >
            Calculer 42 + 58
          </button>
          <div
            id="calc-result"
            class="mt-2 font-mono bg-gray-100 p-2 rounded"
          ></div>
        </div>

        <div class="bg-white rounded-lg shadow p-4">
          <h2 class="text-xl font-semibold text-orange-600 mb-2">random()</h2>
          <p class="text-gray-600 mb-2">Utilise Math.random() de JavaScript</p>
          <button
            id="btn-random"
            class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600"
          >
            G√©n√©rer un nombre al√©atoire (0-100)
          </button>
          <div
            id="random-result"
            class="mt-2 font-mono bg-gray-100 p-2 rounded"
          ></div>
        </div>
      </div>

      <div class="mt-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
        <h3 class="font-bold text-yellow-800">üí° Note technique</h3>
        <p class="text-yellow-700 text-sm mt-1">
          Les fonctions import√©es sont d√©clar√©es avec
          <code>@external("module", "name")</code> et doivent √™tre fournies dans
          l'objet <code>imports</code> lors de l'instanciation.
        </p>
      </div>
    </div>

    <script type="module">
      // √âl√©ments DOM pour les r√©sultats
      const logResult = document.getElementById("log-result");
      const timeResult = document.getElementById("time-result");
      const calcResult = document.getElementById("calc-result");
      const randomResult = document.getElementById("random-result");

      // Imports personnalis√©s pour le module WASM
      const imports = {
        env: {
          // Fonction logNumber appel√©e depuis WASM
          logNumber(value) {
            logResult.innerHTML += `Log: ${value}<br>`;
          },
          // Retourne le timestamp actuel
          getTimestamp() {
            return performance.now();
          },
          // Notification du r√©sultat
          notify(code) {
            calcResult.innerHTML = `üì¢ WASM notifie: r√©sultat = ${code}`;
          },
        },
        math: {
          // Math.random pour WASM
          random() {
            return Math.random();
          },
        },
      };

      // Charger le module WASM avec les imports personnalis√©s
      const wasmModule = await WebAssembly.instantiateStreaming(
        fetch("./build/release.wasm"),
        imports
      );

      const { countWithLog, measureTime, calculate, getRandomInt } =
        wasmModule.instance.exports;

      // Event handlers
      document.getElementById("btn-log").addEventListener("click", () => {
        logResult.innerHTML = "";
        countWithLog(5);
      });

      document.getElementById("btn-time").addEventListener("click", () => {
        const elapsed = measureTime();
        timeResult.innerHTML = `‚è±Ô∏è Temps √©coul√©: ${elapsed.toFixed(2)} ms`;
      });

      document.getElementById("btn-calc").addEventListener("click", () => {
        const result = calculate(42, 58);
        // La notification est faite via notify() dans WASM
      });

      document.getElementById("btn-random").addEventListener("click", () => {
        const rand = getRandomInt(100);
        randomResult.innerHTML = `üé≤ Nombre al√©atoire: ${rand}`;
      });
    </script>
  </body>
</html>
