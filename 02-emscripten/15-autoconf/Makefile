# Simulation du workflow Autoconf/emmake
# Questions QCM: port_q1, port_q8

NODE := $(shell which node)

EXPORTS := -sEXPORTED_FUNCTIONS=_add,_multiply,_version,_main
RUNTIME := -sEXPORTED_RUNTIME_METHODS=ccall,cwrap,UTF8ToString

# =============================================
# Workflow Autoconf standard (simulation)
# =============================================

# Ã‰tape 1: CrÃ©er la bibliothÃ¨que statique (comme aprÃ¨s ./configure && make)
lib:
	@mkdir -p build
	@echo "1. Compilation de la bibliothÃ¨que avec emcc..."
	emcc -c mylib.c -o build/mylib.o
	@echo "2. CrÃ©ation de l'archive avec emar..."
	emar rcs build/libmylib.a build/mylib.o
	@echo "âœ“ BibliothÃ¨que crÃ©Ã©e: build/libmylib.a"

# Ã‰tape 2: Lier la bibliothÃ¨que au programme principal
link: lib
	@mkdir -p dist
	@echo "3. Liaison avec le programme principal..."
	emcc main.c build/libmylib.a -O2 -o dist/autoconf.js $(EXPORTS) $(RUNTIME)
	@echo "âœ“ Module WebAssembly crÃ©Ã©: dist/autoconf.js"

# Build complet
build: link
	@echo "\nðŸ“‹ Workflow Autoconf complet:"
	@echo "   1. emconfigure ./configure  # Configure pour Emscripten"
	@echo "   2. emmake make              # Compile avec emcc"
	@echo "   3. emcc lib.a -o app.js     # Lie en WebAssembly"

# =============================================
# DÃ©monstration des outils Emscripten
# =============================================

# Montre les outils disponibles
show-tools:
	@echo "Outils Emscripten pour le portage:"
	@echo "  emcc      â†’ $(shell which emcc)"
	@echo "  em++      â†’ $(shell which em++)"
	@echo "  emar      â†’ $(shell which emar)"
	@echo "  emranlib  â†’ $(shell which emranlib)"

run:
	$(NODE) wrapper.mjs

clean:
	rm -rf build dist

.PHONY: lib link build show-tools run clean
